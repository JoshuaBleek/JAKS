<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Form</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        #usernameDisplay {
            color: white;
            margin-right: 10px; 
        }
    </style>
</head>
<body>

    <header>
        <h1>JAKS GlideGuide</h1>
        <div class="logo-container">
            <a href="homepage.html">
                <img src="jaks_logo.png" alt="JAKS Logo">
            </a>
        </div>
    </header>

    <nav>
        <a href="flight_view.html">Flight View</a>
        <a href="payments.html">Payment</a>
        <a href="seat_select.html">Seat Selection</a>
        <a href="rate.html">Rate Destination</a>
        <a href="questionnaire.html">Questionnaire</a>
        <a href="refer.html">Refer a Friend</a>
        <a href="upcoming_flights.html">Upcoming Flights</a>
        <a href="points.html">Points</a>
        <div class="right-links">
            <span id="usernameDisplay"></span>
            <button id="logoutButton" style="display:none;">Logout</button>
            <a href="index.html" style="display:none;" id="loginLink">Login</a>
            <a href="register_user.html" style="display:none;" id="registerLink">Register</a>
            <button id="mobileViewToggle" style="display:none;">Toggle Mobile View</button>
        </div>
    </nav>

    <div class="payment-form">
        <h2>Payment Information</h2>
        <form id="paymentForm">
            <div class="form-group">
                <label for="nameOnCard">Name on Card</label>
                <input type="text" id="nameOnCard" required>
                <div class="error" id="nameError"></div>
            </div>

            <div class="form-group">
                <label for="cardNumber">Card Number</label>
                <input type="text" id="cardNumber" pattern="\d*" minlength="16" maxlength="16" required>
                <div class="error" id="cardNumberError"></div>
            </div>

            <div class="form-group">
                <label for="expiryDate">Expiry Date (MM/YYYY)</label>
                <input type="text" id="expiryDate" placeholder="MM/YYYY" required>
                <div class="error" id="expiryDateError"></div>
            </div>

            <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" id="cvv" pattern="\d*" minlength="3" maxlength="3" required>
                <div class="error" id="cvvError"></div>
            </div>

            <div class="form-group">
                <label for="street">Address</label>
                <input type="text" id="street" required>
                <div class="error" id="streetError"></div>
            </div>

            <div class="form-group">
                <label for="town">Town/City</label>
                <input type="text" id="town" required>
                <div class="error" id="townError"></div>
            </div>

            <div class="form-group">
                <label for="zipCode">Zip Code</label>
                <input type="text" id="zipCode" required>
                <div class="error" id="zipCodeError"></div>
            </div>

            <div class="form-group">
                <label for="state">State/Region</label>
                <input type="text" id="state" required>
                <div class="error" id="stateError"></div>
            </div>

            <div class="form-group">
                <label for="country">Country</label>
                <input type="text" id="country" required>
                <div class="error" id="countryError"></div>
            </div>

            <button type="submit">Submit Payment</button>
        </form>
    </div>

    <script>
        document.getElementById('mobileViewToggle').addEventListener('click', function() {
            document.body.classList.toggle('mobile-view'); 
        });
        document.getElementById('mobileViewToggle').style.display = 'inline';

        document.addEventListener('DOMContentLoaded', function() {
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById('usernameDisplay').textContent = 'Welcome, ' + username;
                document.getElementById('logoutButton').style.display = 'inline';
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('registerLink').style.display = 'none';

                document.getElementById('logoutButton').addEventListener('click', function() {
                    localStorage.removeItem('username');
                    window.location.href = 'index.html'; 
                });
            } else {
                document.getElementById('usernameDisplay').textContent = '';
                document.getElementById('logoutButton').style.display = 'none';
                document.getElementById('loginLink').style.display = 'inline';
                document.getElementById('registerLink').style.display = 'inline';
            }
        });

        document.getElementById('paymentForm').addEventListener('submit', function(event) {
            event.preventDefault();

            
            const pointsEarned = 100; 
            let currentPoints = parseInt(localStorage.getItem('userPoints')) || 0;
            localStorage.setItem('userPoints', currentPoints + pointsEarned);
            alert("You earned " + pointsEarned + " points!");

            // Clear previous error messages
            document.getElementById('nameError').textContent = '';
            document.getElementById('cardNumberError').textContent = '';
            document.getElementById('expiryDateError').textContent = '';
            document.getElementById('cvvError').textContent = '';
            document.getElementById('streetError').textContent = '';
            document.getElementById('townError').textContent = '';
            document.getElementById('zipCodeError').textContent = '';
            document.getElementById('stateError').textContent = '';
            document.getElementById('countryError').textContent = '';

            let isValid = true;

            // Validation logic for the input fields
            validateAddressField('nameOnCard', 'Name on card is required.');
            validateAddressField('cardNumber', 'Enter a valid 16-digit card number.', 16);
            validateAddressField('expiryDate', 'Enter a valid expiry date (MM/YYYY).', 7);
            validateAddressField('cvv', 'Enter a valid 3-digit CVV.', 3);
            validateAddressField('street', 'Street is required.');
            validateAddressField('town', 'Town/City is required.');
            validateAddressField('zipCode', 'Zip Code is required.');
            validateAddressField('state', 'State/Region is required.');
            validateAddressField('country', 'Country is required.');

            function validateAddressField(fieldId, errorMessage, maxLength = -1) {
                let fieldValue = document.getElementById(fieldId).value.trim();
                if (fieldValue.length === 0 || (maxLength > 0 && fieldValue.length !== maxLength)) {
                    document.getElementId(fieldId + 'Error').textContent = errorMessage;
                    isValid = false;
                }
            }

            if (isValid) {
                // Process payment
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "payment_producer.php", true);
                xhr.setRequestHeader("Content-Type", "application/json");

                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var json = JSON.parse(xhr.responseText);
                        console.log(json.message);
                    }
                };

                var data = JSON.stringify({
                    "name": document.getElementById("nameOnCard").value,
                    "cardNum": document.getElementId("cardNumber").value,
                    "expiry": document.getElementById("expiryDate").value,
                    "cvv": document.getElementById("cvv").value,
                    "address": document.getElementById("street").value,
                    "town": document.getElementById("town").value,
                    "zipCode": document.getElementById("zipCode").value,
                    "state": document.getElementById("state").value,
                    "country": document.getElementById("country").value
                });

                xhr.send(data);
                document.getElementById('paymentForm').reset();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromBooking = urlParams.get('from') === 'booking';

            if (!fromBooking) {
                alert('Please book a flight before making a payment.');
                window.location.href = 'flight_view.html';
            }
        });
    </script>

</body>
</html>
